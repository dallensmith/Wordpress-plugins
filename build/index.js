(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.blocks,n=window.wp.i18n,i=window.wp.element,r=window.wp.components,s=window.wp.apiFetch;var l=e.n(s);const a=window.wp.compose,o=window.wp.blockEditor,d=window.wp.primitives,b=window.ReactJSXRuntime,m=(0,b.jsx)(d.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,b.jsx)(d.Path,{fillRule:"evenodd",clipRule:"evenodd",d:"M12 5.5A2.25 2.25 0 0 0 9.878 7h4.244A2.251 2.251 0 0 0 12 5.5ZM12 4a3.751 3.751 0 0 0-3.675 3H5v1.5h1.27l.818 8.997a2.75 2.75 0 0 0 2.739 2.501h4.347a2.75 2.75 0 0 0 2.738-2.5L17.73 8.5H19V7h-3.325A3.751 3.751 0 0 0 12 4Zm4.224 4.5H7.776l.806 8.861a1.25 1.25 0 0 0 1.245 1.137h4.347a1.25 1.25 0 0 0 1.245-1.137l.805-8.861Z"})}),g=window.wp.plugins,u=window.wp.editPost,_=window.wp.data,p=window.wp.coreData,c=window.wp.editor,x=["bsbm/movie-entry"];(0,g.registerPlugin)("bsbm-experiment-settings-sidebar",{render:()=>{if("bsbm_experiment"!==(0,_.useSelect)((e=>e(c.store).getCurrentPostType()),[]))return null;const{eventHost:e,eventNotes:t}=(0,_.useSelect)((e=>{const t=e(c.store).getEditedPostAttribute("meta")||{};return{eventHost:void 0===t._bsbm_event_host?null:t._bsbm_event_host,eventNotes:t._bsbm_event_notes||""}}),[]),{editPost:s}=(0,_.useDispatch)(c.store),l=(0,_.useSelect)((e=>e(p.store).getCurrentUser()),[]),a=l?l.name:"";return(0,i.useEffect)((()=>{null===e&&a&&s({meta:{_bsbm_event_host:a}})}),[a]),(0,b.jsxs)(u.PluginDocumentSettingPanel,{name:"bsbm-experiment-settings",title:(0,n.__)("Experiment Details","bsbm-integration"),className:"bsbm-experiment-settings-panel",children:[(0,b.jsx)(r.TextControl,{label:(0,n.__)("Event Host","bsbm-integration"),value:null!=e?e:a,onChange:e=>s({meta:{_bsbm_event_host:e}}),help:(0,n.__)("Defaults to the logged-in user.","bsbm-integration")}),(0,b.jsx)(r.TextareaControl,{label:(0,n.__)("Event Notes","bsbm-integration"),value:t,onChange:e=>s({meta:{_bsbm_event_notes:e}}),rows:5,help:(0,n.__)("Any specific notes about the event (e.g., game winners, technical issues).","bsbm-integration")})]})},icon:"clipboard"}),(0,t.registerBlockType)("bsbm/movies-container",{title:(0,n.__)("Movie Entries Container","bsbm-integration"),description:(0,n.__)("A container to hold one or more movie entries for an experiment.","bsbm-integration"),category:"widgets",icon:"format-gallery",keywords:[(0,n.__)("movie","bsbm-integration"),(0,n.__)("experiment","bsbm-integration"),(0,n.__)("container","bsbm-integration")],supports:{html:!1,reusable:!1,inserter:!0},attributes:{},edit:e=>{const{className:t}=e,i=(0,o.useBlockProps)({className:t});return(0,b.jsxs)("div",{...i,children:[(0,b.jsx)("h4",{style:{marginBottom:"0.5em",marginTop:"0.5em",fontSize:"0.9em",fontStyle:"italic"},children:(0,n.__)("Movies Watched:","bsbm-integration")}),(0,b.jsx)(o.InnerBlocks,{allowedBlocks:x,orientation:"vertical",renderAppender:()=>(0,b.jsx)(o.InnerBlocks.ButtonBlockAppender,{})})]})},save:e=>{const t=o.useBlockProps.save();return(0,b.jsx)("div",{...t,children:(0,b.jsx)(o.InnerBlocks.Content,{})})}}),(0,t.registerBlockType)("bsbm/movie-entry",{title:(0,n.__)("Movie Entry","bsbm-integration"),description:(0,n.__)("Search for and manage details of a single movie within an experiment.","bsbm-integration"),category:"widgets",icon:"video-alt3",parent:["bsbm/movies-container"],supports:{html:!1,reusable:!1,inserter:!1},attributes:{tmdb_id:{type:"integer",default:0},title:{type:"string",default:""},year:{type:"integer",default:0},overview:{type:"string",default:""},poster_url:{type:"string",default:""},backdrop_url:{type:"string",default:""},director:{type:"string",default:""},cast:{type:"string",default:""},genres:{type:"string",default:""},rating:{type:"number",default:0},trailer_url:{type:"string",default:""},imdb_id:{type:"string",default:""},runtime:{type:"integer",default:0},tagline:{type:"string",default:""},release_date:{type:"string",default:""},budget:{type:"integer",default:0},revenue:{type:"integer",default:0},affiliate_links:{type:"array",default:[],items:{type:"object"}}},edit:e=>{const{attributes:t,setAttributes:s,className:d,isSelected:g}=e,{tmdb_id:u,title:_,year:p,overview:c,poster_url:x,backdrop_url:h,director:v,cast:f,genres:y,rating:j,trailer_url:w,imdb_id:C,runtime:k,tagline:T,release_date:S,budget:B,revenue:N,affiliate_links:P}=t,[A,D]=(0,i.useState)(""),[R,E]=(0,i.useState)([]),[I,L]=(0,i.useState)(!1),[F,M]=(0,i.useState)(null),[U,H]=(0,i.useState)(u?t:null),[O,$]=(0,i.useState)(""),[W,V]=(0,i.useState)(""),Y=(0,a.useDebounce)((0,i.useCallback)((e=>{if(!e||e.length<3)return E([]),L(!1),void M(null);L(!0),M(null);const t=`/bsbm/v1/tmdb/search?query=${encodeURIComponent(e)}`;l()({path:t}).then((e=>{E(Array.isArray(e)?e:[]),L(!1)})).catch((e=>{console.error("TMDb Search Error:",e),M(e.message||(0,n.__)("Error fetching search results.","bsbm-integration")),E([]),L(!1)}))}),[]),500),Z=(e,t)=>{s({[e]:t}),U&&H((n=>({...n,[e]:t})))},z=(e,t)=>{const n=""===t?0:parseInt(t,10);Z(e,isNaN(n)?0:n)},G=(e,t,n)=>{const i=(P||[]).map(((i,r)=>r===e?{...i,[t]:n}:i));s({affiliate_links:i})},q=(0,o.useBlockProps)({className:`${d} bsbm-movie-entry-editor ${g?"is-selected":""}`});return(0,b.jsxs)("div",{...q,style:{border:g?"1px solid #007cba":"1px solid #e0e0e0",padding:"15px",marginBottom:"15px",background:"#fff"},children:[" ",(0,b.jsxs)(o.InspectorControls,{children:[(0,b.jsxs)(r.PanelBody,{title:(0,n.__)("Advanced Details","bsbm-integration"),initialOpen:!1,children:[(0,b.jsx)(r.TextControl,{label:(0,n.__)("IMDb ID","bsbm-integration"),value:C,onChange:e=>Z("imdb_id",e),disabled:!U}),(0,b.jsx)(r.__experimentalNumberControl,{label:(0,n.__)("Budget","bsbm-integration"),value:B,onChange:e=>z("budget",e),isShiftStepEnabled:!0,shiftStep:1e6,disabled:!U}),(0,b.jsx)(r.__experimentalNumberControl,{label:(0,n.__)("Revenue","bsbm-integration"),value:N,onChange:e=>z("revenue",e),isShiftStepEnabled:!0,shiftStep:1e6,disabled:!U}),(0,b.jsx)(r.TextControl,{label:(0,n.__)("Backdrop URL","bsbm-integration"),value:h,onChange:e=>Z("backdrop_url",e),disabled:!U})]}),(0,b.jsxs)(r.PanelBody,{title:(0,n.__)("Affiliate Links","bsbm-integration"),initialOpen:!0,children:[(P||[]).length>0&&(0,b.jsxs)("div",{style:{marginBottom:"15px"},children:[(0,b.jsx)("strong",{children:(0,n.__)("Current Links:","bsbm-integration")}),(P||[]).map(((e,t)=>(0,b.jsxs)(r.Flex,{style:{marginBottom:"5px",gap:"5px"},children:[(0,b.jsxs)(r.FlexItem,{children:[" ",(0,b.jsx)(r.TextControl,{label:(0,n.__)("Name","bsbm-integration"),hideLabelFromVision:!0,value:e.name||"",onChange:e=>G(t,"name",e),placeholder:(0,n.__)("Platform Name","bsbm-integration")})," "]}),(0,b.jsxs)(r.FlexItem,{isBlock:!0,children:[" ",(0,b.jsx)(r.TextControl,{label:(0,n.__)("URL","bsbm-integration"),hideLabelFromVision:!0,value:e.url||"",onChange:e=>G(t,"url",e),placeholder:(0,n.__)("Affiliate URL","bsbm-integration"),type:"url"})," "]}),(0,b.jsxs)(r.FlexItem,{children:[" ",(0,b.jsx)(r.Button,{icon:m,label:(0,n.__)("Remove Link","bsbm-integration"),isDestructive:!0,isSmall:!0,onClick:()=>(e=>{const t=(P||[]).filter(((t,n)=>n!==e));s({affiliate_links:t})})(t)})," "]})]},t)))]}),(0,b.jsx)("hr",{style:{margin:"10px 0"}}),(0,b.jsx)("strong",{children:(0,n.__)("Add New Link:","bsbm-integration")}),(0,b.jsx)(r.TextControl,{label:(0,n.__)("Platform Name","bsbm-integration"),value:O,onChange:$,disabled:!U}),(0,b.jsx)(r.TextControl,{label:(0,n.__)("Affiliate URL","bsbm-integration"),value:W,onChange:V,type:"url",disabled:!U}),(0,b.jsxs)(r.Button,{isPrimary:!0,onClick:()=>{if(!O||!W)return;const e=[...P||[],{name:O,url:W}];s({affiliate_links:e}),$(""),V("")},disabled:!O||!W||!U,children:[" ",(0,n.__)("Add Link","bsbm-integration")," "]})]})]}),(0,b.jsx)("h5",{style:{marginTop:0,marginBottom:"10px",fontSize:"1.1em"},children:U?.title||(0,n.__)("New Movie Entry","bsbm-integration")}),U?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{style:{display:"flex",gap:"20px",flexWrap:"wrap"},children:[(0,b.jsxs)("div",{style:{flex:"1 1 150px",minWidth:"120px"},children:[x&&(0,b.jsx)("img",{src:x,alt:"Poster",style:{maxWidth:"100%",height:"auto",marginBottom:"10px",border:"1px solid #ddd"}}),(0,b.jsx)(r.TextControl,{label:(0,n.__)("Poster URL","bsbm-integration"),value:x,onChange:e=>Z("poster_url",e)}),(0,b.jsx)(r.TextControl,{label:(0,n.__)("Trailer URL (YouTube)","bsbm-integration"),value:w,onChange:e=>Z("trailer_url",e),type:"url"})]}),(0,b.jsxs)("div",{style:{flex:"2 1 350px",minWidth:"300px"},children:[(0,b.jsx)(r.TextControl,{label:(0,n.__)("Title","bsbm-integration"),value:_,onChange:e=>Z("title",e)}),(0,b.jsx)(r.TextControl,{label:(0,n.__)("Tagline","bsbm-integration"),value:T,onChange:e=>Z("tagline",e)}),(0,b.jsxs)(r.Flex,{children:[(0,b.jsxs)(r.FlexItem,{children:[" ",(0,b.jsx)(r.__experimentalNumberControl,{label:(0,n.__)("Year","bsbm-integration"),value:p,onChange:e=>z("year",e)})," "]}),(0,b.jsxs)(r.FlexItem,{children:[" ",(0,b.jsx)(r.__experimentalNumberControl,{label:(0,n.__)("Runtime (min)","bsbm-integration"),value:k,onChange:e=>z("runtime",e)})," "]}),(0,b.jsxs)(r.FlexItem,{children:[" ",(0,b.jsx)(r.__experimentalNumberControl,{label:(0,n.__)("Rating","bsbm-integration"),step:"0.1",value:j,onChange:e=>((e,t)=>{const n=""===t?0:parseFloat(t);Z("rating",isNaN(n)?0:n)})(0,e)})," "]})]}),(0,b.jsxs)("div",{style:{marginTop:"10px",marginBottom:"10px"},children:[(0,b.jsx)("label",{children:(0,n.__)("Release Date","bsbm-integration")}),(0,b.jsx)(r.DatePicker,{currentDate:S?`${S}T00:00:00`:null,onChange:e=>{const t=e?e.substring(0,10):"";Z("release_date",t)}})]}),(0,b.jsx)(r.TextareaControl,{label:(0,n.__)("Overview","bsbm-integration"),value:c,onChange:e=>Z("overview",e),rows:5}),(0,b.jsx)(r.TextControl,{label:(0,n.__)("Director(s)","bsbm-integration"),value:v,onChange:e=>Z("director",e)}),(0,b.jsx)(r.TextareaControl,{label:(0,n.__)("Cast (Top 10)","bsbm-integration"),value:f,onChange:e=>Z("cast",e),rows:3,help:(0,n.__)("Comma-separated list","bsbm-integration")}),(0,b.jsx)(r.TextControl,{label:(0,n.__)("Genres","bsbm-integration"),value:y,onChange:e=>Z("genres",e),help:(0,n.__)("Comma-separated list","bsbm-integration")})]})]}),(0,b.jsx)(r.Button,{isSecondary:!0,onClick:()=>{H(null),s({tmdb_id:0,title:"",year:0,overview:"",poster_url:"",backdrop_url:"",director:"",cast:"",genres:"",rating:0,trailer_url:"",imdb_id:"",runtime:0,tagline:"",release_date:"",budget:0,revenue:0,affiliate_links:[]})},style:{marginTop:"15px",display:"block"},children:(0,n.__)("Change Movie / Search Again","bsbm-integration")}),F&&(0,b.jsx)("p",{style:{color:"red",marginTop:"10px"},children:F})]}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(r.TextControl,{label:(0,n.__)("Search TMDb","bsbm-integration"),value:A,onChange:e=>{D(e),L(!0),Y(e)},placeholder:(0,n.__)("Type movie title (min 3 chars)...","bsbm-integration"),help:F?(0,b.jsx)("span",{style:{color:"red"},children:F}):null}),I&&(0,b.jsx)(r.Spinner,{}),!I&&R.length>0&&(0,b.jsx)("ul",{style:{listStyle:"none",margin:"10px 0 0 0",padding:"0",border:"1px solid #eee",maxHeight:"200px",overflowY:"auto",background:"#fff"},children:R.map((e=>(0,b.jsxs)("li",{style:{display:"flex",alignItems:"center",padding:"5px",borderBottom:"1px solid #eee"},children:[e.poster_path&&(0,b.jsx)("img",{src:e.poster_path,alt:"",style:{width:"40px",height:"auto",marginRight:"10px",flexShrink:0}}),(0,b.jsxs)(r.Button,{isLink:!0,onClick:()=>(e=>{L(!0),M(null),D(""),E([]);const t=`/bsbm/v1/tmdb/details/${e.id}`;l()({path:t}).then((e=>{if("object"!=typeof e||null===e)throw new Error((0,n.__)("Invalid details received.","bsbm-integration"));const t={tmdb_id:e.tmdb_id||0,title:e.title||"",year:e.year||0,overview:e.overview||"",poster_url:e.poster_url||"",backdrop_url:e.backdrop_url||"",director:e.director||"",cast:e.cast||"",genres:e.genres||"",rating:e.rating||0,trailer_url:e.trailer_url||"",imdb_id:e.imdb_id||"",runtime:e.runtime||0,tagline:e.tagline||"",release_date:e.release_date||"",budget:e.budget||0,revenue:e.revenue||0,affiliate_links:[]};s(t),H(t),L(!1)})).catch((e=>{console.error("TMDb Details Error:",e),M(e.message||(0,n.__)("Error fetching movie details.","bsbm-integration")),L(!1),H(null)}))})(e),children:[" ",e.title," ",e.release_date?`(${e.release_date.substring(0,4)})`:""," "]})]},e.id)))}),!I&&A.length>=3&&0===R.length&&!F&&(0,b.jsx)("p",{children:(0,n.__)("No results found.","bsbm-integration")})]})]})},save:e=>null})})();